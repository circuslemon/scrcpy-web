<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrcpy Remote Control</title>
    <script src="jmuxer.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: rgba(255, 255, 255, 0.04);
            --primary-green: #4caf50;
            --primary-red: #f44336;
            --text-main: #ddd;
            --text-muted: #888;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-color);
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-main);
            overflow: hidden;
        }

        /* --- ä½ˆå±€çµ„ä»¶ --- */
        .top-nav {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 20px;
            border-radius: 50px;
            display: flex;
            gap: 12px;
            z-index: 1000;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .main-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            padding: 60px 20px 40px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .sidebar {
            width: 260px;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(8px);
            font-size: 14px;
            height: fit-content;
        }

        @media (max-width: 1100px) {
            .sidebar {
                display: none;
            }
        }

        /* --- æ¨¡æ“¬æ‰‹æ©Ÿå¤–æ®¼ --- */
        .phone-wrapper {
            height: 75vh;
            aspect-ratio: 9 / 19.5;
            background: #000;
            border: 12px solid #222;
            border-radius: 36px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
            transition: opacity 0.3s ease;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: crosshair;
        }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid var(--border-color);
            padding: 6px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 13px;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-on {
            background: var(--primary-green);
            border: none;
        }

        .btn-off {
            background: var(--primary-red);
            border: none;
        }

        .bottom-bar {
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 12px;
            color: var(--text-muted);
            border-top: 1px solid var(--border-color);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
            background: var(--primary-red);
        }

        .active-dot {
            background: var(--primary-green);
            box-shadow: 0 0 8px var(--primary-green);
        }
    </style>
</head>

<body>
    <nav class="top-nav">
        <button id="btn-home" class="nav-btn">Home</button>
        <button id="btn-back" class="nav-btn">Back</button>
        <button id="btn-recent" class="nav-btn">Recent</button>
        <button id="btn-power" class="nav-btn btn-on">åµæ¸¬ä¸­</button>
    </nav>

    <main class="main-container">
        <aside class="sidebar">
            <h3>ğŸ® æ“ä½œæŒ‡å—</h3>
            <p>â€¢ <b>å·¦éµé»æ“Šï¼š</b> è§¸æ§è¢å¹•</p>
            <p>â€¢ <b>å·¦éµæ‹–æ›³ï¼š</b> æ»‘å‹•é é¢</p>
        </aside>

        <section class="phone-wrapper" id="phone-container">
            <video id="player" autoplay muted playsinline></video>
        </section>

        <aside class="sidebar">
            <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
            <p>â€¢ è¢å¹•é—œé–‰æ™‚å°èˆªéµå°‡å¤±æ•ˆ</p>
            <!-- <p>â€¢ é›¢é–‹å‰è«‹é—œé–‰è¢å¹•ä»¥çœé›»</p> -->
        </aside>
    </main>

    <footer class="bottom-bar">
        <div><span id="conn-dot" class="status-dot"></span> <span id="conn-text">åˆå§‹åŒ–...</span></div>
        <span>|</span>
        <div id="device-info">Device: ---</div>
        <span>|</span>
        <div id="power-text">Power: Unknown</div>
        <span>|</span>
        <div id="res-info">0x0</div>
    </footer>

    <script>
        class ScrcpyClient {
            constructor(serial) {
                if (!serial) return alert('ç¼ºå°‘è¨­å‚™åºè™Ÿ (Serial Number)');
                this.serial = serial;
                this.isAwake = false;
                this.isFirstStatus = true;

                // DOM å¼•ç”¨
                this.video = document.getElementById('player');
                this.btnPower = document.getElementById('btn-power');
                this.navBtns = ['btn-home', 'btn-back', 'btn-recent'].map(id => document.getElementById(id));

                this.initJMuxer();
                this.connect();
                this.bindEvents();
            }

            /**
             * åˆå§‹åŒ–å½±éŸ³è§£ç¢¼å™¨ (H.264 -> MediaSource)
             */
            initJMuxer() {
                this.jmuxer = new JMuxer({
                    node: 'player',
                    mode: 'video',
                    flushingTime: 0,    // 0 ä»£è¡¨æœ‰æ•¸æ“šç«‹å³æ¨å‘è§£ç¢¼å™¨ï¼Œé™ä½å»¶é²
                    clearBuffer: true,  // é¿å…è§£ç¢¼å™¨å…§éƒ¨ç·©å­˜å †ç©
                    fps: 60,
                    debug: false
                });
            }

            /**
             * å»ºç«‹ WebSocket é€£ç·š
             */
            connect() {
                const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${protocol}//${location.host}?serial=${this.serial}`);
                this.ws.binaryType = 'arraybuffer'; // é‡è¦ï¼šæ¥æ”¶äºŒé€²ä½å½±éŸ³æµ

                this.ws.onopen = () => this.updateUIStatus(true);
                this.ws.onclose = () => this.updateUIStatus(false);
                this.ws.onmessage = (e) => this.handleIncomingData(e.data);
            }

            /**
             * è™•ç†å¾Œç«¯å‚³å›çš„æ··åˆæ•¸æ“š (JSON ç‹€æ…‹æˆ–äºŒé€²ä½å½±åƒ)
             */
            handleIncomingData(data) {
                const uint8 = new Uint8Array(data);

                // åˆ¤æ–·æ˜¯å¦ç‚º H.264 å½±åƒé ­ (é€šå¸¸ä»¥ 00 00 00 01 é–‹é ­)
                const isVideo = (uint8[0] === 0 && uint8[1] === 0 && uint8[2] === 0 && uint8[3] === 1);

                // å¦‚æœä¸æ˜¯å½±éŸ³æ•¸æ“šä¸”é•·åº¦è¼ƒçŸ­ï¼Œå˜—è©¦è§£æç‚º JSON æ§åˆ¶è¨Šæ¯
                if (!isVideo && data.byteLength < 1000) {
                    try {
                        const text = new TextDecoder().decode(uint8).trim();
                        if (text.startsWith('{')) {
                            this.processControlJson(JSON.parse(text));
                            return;
                        }
                    } catch (e) { /* è§£æå¤±æ•—è¦–ç‚ºå½±åƒç¢ç‰‡ */ }
                }

                // é€å…¥è§£ç¢¼å™¨æ¸²æŸ“ç•«é¢
                this.jmuxer.feed({ video: uint8 });
            }

            /**
             * è™•ç†è£ç½®ç‹€æ…‹æ›´æ–° (é›»æºã€å‹è™Ÿ)
             */
            processControlJson(msg) {
                if (msg.type === 'status') {
                    const awake = msg.wakeState === 'Awake';

                    // åˆæ¬¡é€£ç·šå„ªåŒ–ï¼šè‹¥ä¼‘çœ å‰‡å–šé†’ï¼Œè‹¥é†’è‘—å‰‡åˆ·æ–° UI
                    if (this.isFirstStatus) {
                        if (!awake) this.send({ type: 'wake' });
                        else {
                            this.send({ type: 'key', keycode: 3 }); // å‚³é€ Home éµç¢ºä¿ç•«é¢åˆ·æ–°
                            setTimeout(() => this.send({ type: 'key', keycode: 3 }), 150);
                        }
                        this.isFirstStatus = false;
                    }
                    this.updatePowerUI(awake);
                }

                if (msg.type === 'info') {
                    document.getElementById('device-info').innerText = `${msg.model} (${msg.version})`;
                }
            }

            /**
             * æ›´æ–°é€£ç·šé»èˆ‡ç‹€æ…‹æ–‡å­—
             */
            updateUIStatus(connected) {
                const dot = document.getElementById('conn-dot');
                const text = document.getElementById('conn-text');
                text.innerText = connected ? `å·²é€£ç·š (${this.serial})` : 'é€£ç·šä¸­æ–·';
                dot.className = `status-dot ${connected ? 'active-dot' : ''}`;
            }

            /**
             * æ›´æ–°æ‰‹æ©Ÿé›»æºç‹€æ…‹ç›¸é—œ UI
             */
            updatePowerUI(isAwake) {
                this.isAwake = isAwake;
                const pText = document.getElementById('power-text');
                const wrapper = document.getElementById('phone-container');

                pText.innerText = `Power: ${isAwake ? 'ON' : 'OFF'}`;
                pText.style.color = isAwake ? '#4caf50' : '#888';
                wrapper.style.opacity = isAwake ? '1' : '0.4';

                this.btnPower.innerText = isAwake ? 'é—œé–‰æ‰‹æ©Ÿè¢å¹•' : 'é–‹å•Ÿæ‰‹æ©Ÿè¢å¹•';
                this.btnPower.className = `nav-btn ${isAwake ? 'btn-off' : 'btn-on'}`;
                this.navBtns.forEach(btn => btn.disabled = !isAwake);
            }

            /**
             * å‚³é€æŒ‡ä»¤è‡³å¾Œç«¯
             */
            send(obj) {
                if (this.ws?.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(obj));
                }
            }

            /**
             * ç¶å®š UI äº‹ä»¶èˆ‡è§¸æ§é‚è¼¯
             */
            bindEvents() {
                // è§£æåº¦é¡¯ç¤º
                this.video.onplaying = () => {
                    document.getElementById('res-info').innerText = `${this.video.videoWidth}x${this.video.videoHeight}`;
                };

                // å°èˆªéµ (Android Keycodes: Home=3, Back=4, Recent=187)
                const keyMap = { 'btn-home': 3, 'btn-back': 4, 'btn-recent': 187 };
                Object.entries(keyMap).forEach(([id, code]) => {
                    document.getElementById(id).onclick = () => this.send({ type: 'key', keycode: code });
                });

                // é›»æºéµ
                this.btnPower.onclick = () => {
                    this.btnPower.innerText = "è™•ç†ä¸­...";
                    this.send({ type: 'wake' });
                };

                // è§¸æ§è½‰æ›é‚è¼¯ (å°‡æ»‘é¼ é»æ“Šè½‰ç‚º 0.0~1.0 çš„ç™¾åˆ†æ¯”åº§æ¨™)
                const handleTouch = (action, e) => {
                    const rect = this.video.getBoundingClientRect();
                    const { videoWidth: vw, videoHeight: vh } = this.video;
                    if (!vw) return;

                    // è¨ˆç®—å½±ç‰‡åœ¨å…ƒä»¶å…§çš„å¯¦éš›ç¸®æ”¾æ¯”ä¾‹ (contain æ¨¡å¼)
                    const scale = Math.min(rect.width / vw, rect.height / vh);
                    const offsetX = (rect.width - vw * scale) / 2;
                    const offsetY = (rect.height - vh * scale) / 2;

                    // å–å¾—ç›¸å°æ–¼å½±åƒå€åŸŸçš„ 0.0 ~ 1.0 æ¯”ä¾‹
                    const dx = (e.clientX - rect.left - offsetX) / (vw * scale);
                    const dy = (e.clientY - rect.top - offsetY) / (vh * scale);

                    if (dx >= 0 && dx <= 1 && dy >= 0 && dy <= 1) {
                        this.send({ type: 'touch', action, x: dx, y: dy });
                    }
                };

                // æ»‘é¼ è§¸æ§äº‹ä»¶ç¶å®š
                let isDragging = false;
                this.video.onmousedown = (e) => { if (e.button === 0) { isDragging = true; handleTouch(0, e); } };
                window.onmousemove = (e) => { if (isDragging) handleTouch(2, e); };
                window.onmouseup = (e) => { if (isDragging) { isDragging = false; handleTouch(1, e); } };

                // [æ¥µé‡è¦] ä½å»¶é²åŒæ­¥å™¨ï¼š
                // ç•¶ç€è¦½å™¨æ¨™ç±¤èƒŒæ™¯åŒ–æˆ–ç¶²è·¯æ³¢å‹•ï¼ŒVideo æ’­æ”¾é€²åº¦æœƒè½å¾Œæ–¼ Buffer
                // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œè‹¥è½å¾Œè¶…é 0.2 ç§’å‰‡å¼·è¡Œè·³è‡³æœ€æ–°å¹€
                setInterval(() => {
                    if (this.video.buffered.length) {
                        const end = this.video.buffered.end(0);
                        if (end - this.video.currentTime > 0.2) {
                            this.video.currentTime = end - 0.01;
                        }
                    }
                }, 1000);
            }
        }

        // å•Ÿå‹•æ‡‰ç”¨
        const client = new ScrcpyClient(new URLSearchParams(window.location.search).get('serial'));
    </script>
</body>

</html>